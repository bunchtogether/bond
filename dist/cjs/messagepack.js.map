{"version":3,"file":"messagepack.js","names":["Ping","timestamp","writePing","encoded","readPing","decoded","Class","type","write","read","Pong","wallclock","writePong","readPong","ObservedRemoveDump","queue","writeObservedRemoveDump","readObservedRemoveDump","PeerEvent","args","writePeerEvent","readPeerEvent","Close","code","message","writeClose","readClose","incrementedChunkId","Math","random","MergeChunksPromise","timeoutDuration","chunkCallbacks","resolve","reject","id","merged","bytesReceived","timeoutHandler","Error","timeout","setTimeout","addChunk","multipartContainer","Buffer","alloc","length","clearTimeout","buffer","copy","position","push","chunkCallback","Promise","Symbol","species","toStringTag","MultipartContainer","chunk","size","chunks","i","slice","getMergeChunksPromise","decodeMultipartContainer","readUInt32BE","encodeMultipartContainer","allocUnsafe","writeUInt32BE","pack","unpack"],"sources":["../../src/messagepack.js"],"sourcesContent":["// @flow\n\nimport {\n  pack,\n  addExtension,\n} from 'msgpackr';\n\nexport class Ping {\n  constructor(timestamp:number) {\n    this.timestamp = timestamp;\n  }\n  declare timestamp: number;\n}\n\nfunction writePing(encoded: Ping) {\n  return encoded.timestamp;\n}\n\nfunction readPing(decoded: number) {\n  return new Ping(decoded);\n}\n\naddExtension({\n  Class: Ping,\n  type: 0x90,\n  write: writePing,\n  read: readPing,\n});\n\nexport class Pong {\n  constructor(timestamp:number, wallclock:number) {\n    this.timestamp = timestamp;\n    this.wallclock = wallclock;\n  }\n  declare timestamp: number;\n  declare wallclock: number;\n}\n\nfunction writePong(encoded: Pong) {\n  return [encoded.timestamp, encoded.wallclock];\n}\n\nfunction readPong(decoded:[number, number]) {\n  return new Pong(decoded[0], decoded[1]);\n}\n\naddExtension({\n  Class: Pong,\n  type: 0x91,\n  write: writePong,\n  read: readPong,\n});\n\nexport class ObservedRemoveDump {\n  constructor(queue:[Array<*>, Array<*>]) {\n    this.queue = queue;\n  }\n  declare queue:[Array<*>, Array<*>];\n}\n\nfunction writeObservedRemoveDump(encoded: ObservedRemoveDump) {\n  return encoded.queue;\n}\n\nfunction readObservedRemoveDump(decoded:[Array<*>, Array<*>]) {\n  return new ObservedRemoveDump(decoded);\n}\n\naddExtension({\n  Class: ObservedRemoveDump,\n  type: 0x92,\n  write: writeObservedRemoveDump,\n  read: readObservedRemoveDump,\n});\n\nexport class PeerEvent {\n  constructor(type:string, args:Array<any>) {\n    this.type = type;\n    this.args = args;\n  }\n  declare type:string;\n  declare args: Array<any>;\n}\n\nfunction writePeerEvent(encoded: PeerEvent) {\n  return [encoded.type, encoded.args];\n}\n\nfunction readPeerEvent(decoded:[string, Array<any>]) {\n  return new PeerEvent(decoded[0], decoded[1]);\n}\n\naddExtension({\n  Class: PeerEvent,\n  type: 0x93,\n  write: writePeerEvent,\n  read: readPeerEvent,\n});\n\nexport class Close {\n  constructor(code:number, message:string) {\n    this.code = code;\n    this.message = message;\n  }\n  declare code: number;\n  declare message: string;\n}\n\nfunction writeClose(encoded: Close) {\n  return [encoded.code, encoded.message];\n}\n\nfunction readClose(decoded:[number, string]) {\n  return new Close(decoded[0], decoded[1]);\n}\n\naddExtension({\n  Class: Close,\n  type: 0x94,\n  write: writeClose,\n  read: readClose,\n});\n\nlet incrementedChunkId = (Math.random() * 4294967296) >>> 0;\n\nexport class MergeChunksPromise extends Promise<Buffer> {\n  declare chunkCallbacks: Array<(MultipartContainer) => void>;\n  constructor(timeoutDuration: number) {\n    const chunkCallbacks = [];\n    super((resolve, reject) => {\n      let id;\n      let merged;\n      let bytesReceived = 0;\n      const timeoutHandler = () => {\n        reject(new Error(`MultipartContainer chunk timeout error after ${timeoutDuration}ms`));\n      };\n      let timeout = setTimeout(timeoutHandler, timeoutDuration);\n      const addChunk = (multipartContainer:MultipartContainer) => {\n        if (typeof id === 'undefined' || typeof merged === 'undefined') {\n          id = multipartContainer.id;\n          merged = Buffer.alloc(multipartContainer.length);\n        } else if (multipartContainer.id !== id) {\n          return;\n        }\n        clearTimeout(timeout);\n        multipartContainer.buffer.copy(merged, multipartContainer.position);\n        bytesReceived += multipartContainer.buffer.length;\n        if (bytesReceived < multipartContainer.length) {\n          timeout = setTimeout(timeoutHandler, timeoutDuration);\n          return;\n        }\n        resolve(merged);\n      };\n      chunkCallbacks.push(addChunk);\n    });\n    this.chunkCallbacks = chunkCallbacks;\n  }\n\n  push(multipartContainer:MultipartContainer) {\n    for (const chunkCallback of this.chunkCallbacks) {\n      chunkCallback(multipartContainer);\n    }\n  }\n\n  // $FlowFixMe\n  static get [Symbol.species]() {\n    return Promise;\n  }\n\n  // $FlowFixMe\n  get [Symbol.toStringTag]() {\n    return 'MergeChunksPromise';\n  }\n}\n\nexport class MultipartContainer {\n  static chunk: (Buffer, number) => Array<Buffer>;\n\n  static getMergeChunksPromise: (number) => MergeChunksPromise;\n\n  constructor(id:number, position:number, length: number, buffer:Buffer) {\n    this.id = id;\n    this.position = position;\n    this.length = length;\n    this.buffer = buffer;\n  }\n  declare id:number;\n  declare position:number;\n  declare length:number;\n  declare buffer:Buffer;\n}\n\nMultipartContainer.chunk = (buffer:Buffer, size:number) => {\n  const chunks = [];\n  for (let i = 0; i * size < buffer.length; i += 1) {\n    const slice = buffer.slice(i * size, (i + 1) * size);\n    chunks.push(pack(new MultipartContainer(incrementedChunkId, i * size, buffer.length, slice)));\n  }\n  incrementedChunkId += 1;\n  if (incrementedChunkId > 4294967294) {\n    incrementedChunkId = 0;\n  }\n  return chunks;\n};\n\nMultipartContainer.getMergeChunksPromise = (timeoutDuration: number) => new MergeChunksPromise(timeoutDuration);\n\nfunction decodeMultipartContainer(buffer: Buffer) {\n  const id = buffer.readUInt32BE(0);\n  const position = buffer.readUInt32BE(4);\n  const length = buffer.readUInt32BE(8);\n  return new MultipartContainer(id, position, length, buffer.slice(12));\n}\n\nfunction encodeMultipartContainer(multipartContainer: MultipartContainer) {\n  const buffer = Buffer.allocUnsafe(multipartContainer.buffer.length + 12);\n  buffer.writeUInt32BE(multipartContainer.id, 0);\n  buffer.writeUInt32BE(multipartContainer.position, 4);\n  buffer.writeUInt32BE(multipartContainer.length, 8);\n  multipartContainer.buffer.copy(buffer, 12);\n  return buffer;\n}\n\naddExtension({\n  Class: MultipartContainer,\n  type: 0x95,\n  pack: encodeMultipartContainer,\n  unpack: decodeMultipartContainer,\n});\n"],"mappings":"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"}