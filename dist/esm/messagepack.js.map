{"version":3,"sources":["../../src/messagepack.js"],"names":["pack","addExtension","Ping","constructor","timestamp","writePing","encoded","readPing","decoded","Class","type","write","read","Pong","wallclock","writePong","readPong","ObservedRemoveDump","queue","writeObservedRemoveDump","readObservedRemoveDump","PeerEvent","args","writePeerEvent","readPeerEvent","Close","code","message","writeClose","readClose","incrementedChunkId","Math","random","MergeChunksPromise","Promise","timeoutDuration","chunkCallbacks","resolve","reject","id","merged","bytesReceived","timeoutHandler","Error","timeout","setTimeout","addChunk","multipartContainer","Buffer","alloc","length","clearTimeout","buffer","copy","position","push","chunkCallback","Symbol","species","toStringTag","MultipartContainer","chunk","size","chunks","i","slice","getMergeChunksPromise","decodeMultipartContainer","readUInt32BE","encodeMultipartContainer","allocUnsafe","writeUInt32BE","unpack"],"mappings":"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","sourcesContent":["// @flow\n\nimport {\n  pack,\n  addExtension,\n} from 'msgpackr';\n\nexport class Ping {\n  constructor(timestamp:number) {\n    this.timestamp = timestamp;\n  }\n  declare timestamp: number;\n}\n\nfunction writePing(encoded: Ping) {\n  return encoded.timestamp;\n}\n\nfunction readPing(decoded: number) {\n  return new Ping(decoded);\n}\n\naddExtension({\n  Class: Ping,\n  type: 0x90,\n  write: writePing,\n  read: readPing,\n});\n\nexport class Pong {\n  constructor(timestamp:number, wallclock:number) {\n    this.timestamp = timestamp;\n    this.wallclock = wallclock;\n  }\n  declare timestamp: number;\n  declare wallclock: number;\n}\n\nfunction writePong(encoded: Pong) {\n  return [encoded.timestamp, encoded.wallclock];\n}\n\nfunction readPong(decoded:[number, number]) {\n  return new Pong(decoded[0], decoded[1]);\n}\n\naddExtension({\n  Class: Pong,\n  type: 0x91,\n  write: writePong,\n  read: readPong,\n});\n\nexport class ObservedRemoveDump {\n  constructor(queue:[Array<*>, Array<*>]) {\n    this.queue = queue;\n  }\n  declare queue:[Array<*>, Array<*>];\n}\n\nfunction writeObservedRemoveDump(encoded: ObservedRemoveDump) {\n  return encoded.queue;\n}\n\nfunction readObservedRemoveDump(decoded:[Array<*>, Array<*>]) {\n  return new ObservedRemoveDump(decoded);\n}\n\naddExtension({\n  Class: ObservedRemoveDump,\n  type: 0x92,\n  write: writeObservedRemoveDump,\n  read: readObservedRemoveDump,\n});\n\nexport class PeerEvent {\n  constructor(type:string, args:Array<any>) {\n    this.type = type;\n    this.args = args;\n  }\n  declare type:string;\n  declare args: Array<any>;\n}\n\nfunction writePeerEvent(encoded: PeerEvent) {\n  return [encoded.type, encoded.args];\n}\n\nfunction readPeerEvent(decoded:[string, Array<any>]) {\n  return new PeerEvent(decoded[0], decoded[1]);\n}\n\naddExtension({\n  Class: PeerEvent,\n  type: 0x93,\n  write: writePeerEvent,\n  read: readPeerEvent,\n});\n\nexport class Close {\n  constructor(code:number, message:string) {\n    this.code = code;\n    this.message = message;\n  }\n  declare code: number;\n  declare message: string;\n}\n\nfunction writeClose(encoded: Close) {\n  return [encoded.code, encoded.message];\n}\n\nfunction readClose(decoded:[number, string]) {\n  return new Close(decoded[0], decoded[1]);\n}\n\naddExtension({\n  Class: Close,\n  type: 0x94,\n  write: writeClose,\n  read: readClose,\n});\n\nlet incrementedChunkId = (Math.random() * 4294967296) >>> 0;\n\nexport class MergeChunksPromise extends Promise<Buffer> {\n  declare chunkCallbacks: Array<(MultipartContainer) => void>;\n  constructor(timeoutDuration: number) {\n    const chunkCallbacks = [];\n    super((resolve, reject) => {\n      let id;\n      let merged;\n      let bytesReceived = 0;\n      const timeoutHandler = () => {\n        reject(new Error(`MultipartContainer chunk timeout error after ${timeoutDuration}ms`));\n      };\n      let timeout = setTimeout(timeoutHandler, timeoutDuration);\n      const addChunk = (multipartContainer:MultipartContainer) => {\n        if (typeof id === 'undefined' || typeof merged === 'undefined') {\n          id = multipartContainer.id;\n          merged = Buffer.alloc(multipartContainer.length);\n        } else if (multipartContainer.id !== id) {\n          return;\n        }\n        clearTimeout(timeout);\n        multipartContainer.buffer.copy(merged, multipartContainer.position);\n        bytesReceived += multipartContainer.buffer.length;\n        if (bytesReceived < multipartContainer.length) {\n          timeout = setTimeout(timeoutHandler, timeoutDuration);\n          return;\n        }\n        resolve(merged);\n      };\n      chunkCallbacks.push(addChunk);\n    });\n    this.chunkCallbacks = chunkCallbacks;\n  }\n\n  push(multipartContainer:MultipartContainer) {\n    for (const chunkCallback of this.chunkCallbacks) {\n      chunkCallback(multipartContainer);\n    }\n  }\n\n  // $FlowFixMe\n  static get [Symbol.species]() {\n    return Promise;\n  }\n\n  // $FlowFixMe\n  get [Symbol.toStringTag]() {\n    return 'MergeChunksPromise';\n  }\n}\n\nexport class MultipartContainer {\n  static chunk: (Buffer, number) => Array<Buffer>;\n\n  static getMergeChunksPromise: (number) => MergeChunksPromise;\n\n  constructor(id:number, position:number, length: number, buffer:Buffer) {\n    this.id = id;\n    this.position = position;\n    this.length = length;\n    this.buffer = buffer;\n  }\n  declare id:number;\n  declare position:number;\n  declare length:number;\n  declare buffer:Buffer;\n}\n\nMultipartContainer.chunk = (buffer:Buffer, size:number) => {\n  const chunks = [];\n  for (let i = 0; i * size < buffer.length; i += 1) {\n    const slice = buffer.slice(i * size, (i + 1) * size);\n    chunks.push(pack(new MultipartContainer(incrementedChunkId, i * size, buffer.length, slice)));\n  }\n  incrementedChunkId += 1;\n  if (incrementedChunkId > 4294967294) {\n    incrementedChunkId = 0;\n  }\n  return chunks;\n};\n\nMultipartContainer.getMergeChunksPromise = (timeoutDuration: number) => new MergeChunksPromise(timeoutDuration);\n\nfunction decodeMultipartContainer(buffer: Buffer) {\n  const id = buffer.readUInt32BE(0);\n  const position = buffer.readUInt32BE(4);\n  const length = buffer.readUInt32BE(8);\n  return new MultipartContainer(id, position, length, buffer.slice(12));\n}\n\nfunction encodeMultipartContainer(multipartContainer: MultipartContainer) {\n  const buffer = Buffer.allocUnsafe(multipartContainer.buffer.length + 12);\n  buffer.writeUInt32BE(multipartContainer.id, 0);\n  buffer.writeUInt32BE(multipartContainer.position, 4);\n  buffer.writeUInt32BE(multipartContainer.length, 8);\n  multipartContainer.buffer.copy(buffer, 12);\n  return buffer;\n}\n\naddExtension({\n  Class: MultipartContainer,\n  type: 0x95,\n  pack: encodeMultipartContainer,\n  unpack: decodeMultipartContainer,\n});\n"],"file":"messagepack.js"}